# Write your code here :-)
import datetime
import time
import json
import daemon
import board
import adafruit_dht
import requests
#import schedule
import mysql.connector
from datetime import datetime, timedelta
dhtDevice = adafruit_dht.DHT11(board.D17)

def job():
    now = datetime.now()
    y = True
    while y:
        try:
            #get readings
            now = datetime.now()
            current_time = now.strftime("%Y-%m-%d %H:%M:%S")
            print("Current Time =", current_time)

            temperature_c = dhtDevice.temperature
            humidity = dhtDevice.humidity
            #post current readings
            #if it fails to connect run the exceptions
            if humidity is not None and temperature_c is not None:
                print("Temp: {:.1f} C    Humidity: {}% "
                    .format(temperature_c, humidity))
                
                url = 'http://dmitryg.pythonanywhere.com/data/send'
                myobj = {"date_time": current_time,
                "temperature": temperature_c,
                "humidity": humidity,
                "pi_id": 1
                }
                response = requests.post(url, json = myobj, headers = {"Authorization" : "8f964878-5f6e-44c8-9a9f-15a6deb3a263"})
                print(response.text)
                y = False
            #post local readings
            offlinejob()
        except (requests.ConnectionError, requests.Timeout) as exception:
            print("No internet Connection")
            mydb = mysql.connector.connect(
            host= "localhost",
            user= "dima",
            password= "password",
            database= "dht2db",)

            mycursor = mydb.cursor()
            mycursor.execute("INSERT INTO Sensordata (date_time, temperature, humidity) VALUES (\'%s\',\'%s\','%s\')"%(current_time,temperature_c,humidity))
            print("saved locally")
            mydb.commit()
            mycursor.close()
            mydb.close()
        except RuntimeError as error:
            print(error.args[0])
            time.sleep(1.0)
            continue
        except Exception as error:
            dhtDevice.exit()
            print(error.args[0])
            time.sleep(1)
        time.sleep(1)

job()
def offlinejob:
    url = 'http://dmitryg.pythonanywhere.com/data/send'
    try:
        mydb = mysql.connector.connect(
            host= "localhost",
            user= "dima",
            password= "password",
            database= "dht2db",)

        mycursor = mydb.cursor()
        mycursor.execute("SELECT * FROM Sensordata")
        result = mycursor.fetchall()
        if result is not None:
            mycursor.execute("DELETE FROM Sensordata")
            for x in result:
                date_time = x[0].strftime("%Y-%m-%d %H:%M:%S")
                temperature = x[1]
                humidity = x[2]
                myobj = {"date_time": date_time,
                "temperature": temperature,
                "humidity": humidity,
                "pi_id": 1
                }
                response = requests.post(url, json = myobj, headers = {"Authorization" : "8f964878-5f6e-44c8-9a9f-15a6deb3a263"})
                print(response.text)
        mydb.commit()
        mycursor.close()
        mydb.close()
    except Exception as e:
        print(e)

#schedule.every(5).seconds.do(job)
#while True:
    #schedule.run_pending()
    #time.sleep(1)
